"use strict";(()=>{var e={};e.id=5724,e.ids=[5724],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1215:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>m,patchFetch:()=>d,requestAsyncStorage:()=>p,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var r={};s.r(r),s.d(r,{GET:()=>l,POST:()=>c});var a=s(9303),i=s(8716),n=s(670),o=s(7070),u=s(5193);async function l(e){try{let t=new URL(e.url),s=t.searchParams.get("action")||"stats",r=t.searchParams.get("provider");switch(console.log(`ðŸ” API Keys request: action=${s}, provider=${r}`),s){case"stats":return function(e){let t=u.h.getStats(e),s=new Date().toISOString();return o.NextResponse.json({provider:e||"all",timestamp:s,stats:t,summary:{totalKeys:Object.keys(t).length,totalRequests:Object.values(t).reduce((e,t)=>e+t.totalRequests,0),totalErrors:Object.values(t).reduce((e,t)=>e+t.failedRequests,0),averageResponseTime:Object.values(t).reduce((e,t)=>e+t.averageResponseTime,0)/Object.keys(t).length,totalCost:Object.values(t).reduce((e,t)=>e+t.totalCost,0)}})}(r||void 0);case"security":return function(){let e;let t=u.h.getSecurityReport(),s=new Date().toISOString();return o.NextResponse.json({timestamp:s,securityReport:t,riskAssessment:{overallRisk:(e=0,(t.errorsInLastHour>10?e+=3:t.errorsInLastHour>5?e+=2:t.errorsInLastHour>0&&(e+=1),t.bannedKeys>0&&(e+=2),t.highUsageKeys.length>0&&(e+=1),t.rateLimitHits>100?e+=2:t.rateLimitHits>50&&(e+=1),e>=5)?"critical":e>=3?"high":e>=1?"medium":"low"),recommendations:function(e){let t=[];return e.errorsInLastHour>10&&t.push("High error rate detected - investigate API key configuration and quotas"),e.bannedKeys>0&&t.push(`${e.bannedKeys} API keys are temporarily banned - monitor for recurring issues`),e.highUsageKeys.length>0&&t.push("Some API keys approaching daily quota limits - consider adding backup keys"),e.rateLimitHits>50&&t.push("Frequent rate limiting - implement request throttling or upgrade API plans"),0===t.length&&t.push("API key security looks good - continue monitoring"),t}(t),healthScore:Math.max(100-Math.min(2*t.errorsInLastHour,30)-Math.min(20*t.bannedKeys,40)-Math.min(5*t.highUsageKeys.length,15)-Math.min(t.rateLimitHits/10,15),0)}})}();case"usage":return function(){let e=u.h.getStats(),t=new Date().toISOString(),s={topPerformers:Object.entries(e).sort(([e,t],[s,r])=>t.successfulRequests-r.successfulRequests).slice(0,3).map(([e,t])=>({keyId:e,requests:t.successfulRequests})),problemKeys:Object.entries(e).filter(([e,t])=>t.failedRequests>.1*t.successfulRequests).map(([e,t])=>({keyId:e,errorRate:t.failedRequests/t.totalRequests})),costOptimization:Object.entries(e).sort(([e,t],[s,r])=>t.totalCost/t.successfulRequests-r.totalCost/r.successfulRequests).slice(0,3).map(([e,t])=>({keyId:e,costPerRequest:t.totalCost/Math.max(t.successfulRequests,1),totalCost:t.totalCost}))};return o.NextResponse.json({timestamp:t,usageAnalysis:s,efficiency:{averageSuccessRate:Object.values(e).reduce((e,t)=>e+t.successfulRequests/Math.max(t.totalRequests,1),0)/Object.keys(e).length,totalCostEfficiency:Object.values(e).reduce((e,t)=>e+t.totalCost,0)/Math.max(Object.values(e).reduce((e,t)=>e+t.totalRequests,0),1)}})}();case"status":return function(){let e=u.h.getSecurityReport(),t=new Date().toISOString();return o.NextResponse.json({timestamp:t,status:{systemHealth:e.activeKeys>0?"healthy":"critical",activeKeys:e.activeKeys,totalKeys:e.totalKeys,securityAlerts:e.errorsInLastHour,rateLimitIssues:e.rateLimitHits,lastUpdate:t},alerts:function(e){let t=[];return e.errorsInLastHour>10&&t.push({level:"critical",message:`High error rate: ${e.errorsInLastHour} errors in the last hour`,action:"Investigate API key configuration immediately"}),e.bannedKeys>0&&t.push({level:"warning",message:`${e.bannedKeys} API keys are temporarily banned`,action:"Monitor key performance and consider adding backup keys"}),e.highUsageKeys.length>0&&t.push({level:"warning",message:`${e.highUsageKeys.length} keys approaching quota limits`,action:"Review usage patterns and consider upgrading plans"}),0===e.activeKeys&&t.push({level:"critical",message:"No active API keys available",action:"Check API key configuration immediately"}),t}(e)})}();default:return o.NextResponse.json({error:"Invalid action",availableActions:["stats","security","usage","status"]},{status:400})}}catch(e){return console.error("âŒ API Keys API error:",e),o.NextResponse.json({error:"Internal server error",message:e.message},{status:500})}}async function c(e){try{let{action:t}=await e.json();switch(console.log(`ðŸ” API Keys POST action: ${t}`),t){case"reset":return function(){try{return u.h.resetDaily(),o.NextResponse.json({success:!0,message:"Daily usage reset completed",timestamp:new Date().toISOString()})}catch(e){return o.NextResponse.json({success:!1,error:e.message,timestamp:new Date().toISOString()},{status:500})}}();case"test":return function(){try{let e=u.h.getApiKey("google"),t=u.h.getApiKey("huggingface"),s={google:{available:!!e,keyPreview:e?`${e.substring(0,8)}...`:null},huggingface:{available:!!t,keyPreview:t?`${t.substring(0,8)}...`:null}};return o.NextResponse.json({success:!0,testResults:s,timestamp:new Date().toISOString(),message:"API key availability test completed"})}catch(e){return o.NextResponse.json({success:!1,error:e.message,timestamp:new Date().toISOString()},{status:500})}}();default:return o.NextResponse.json({error:"Invalid action",availableActions:["reset","test"]},{status:400})}}catch(e){return console.error("âŒ API Keys POST error:",e),o.NextResponse.json({error:"Internal server error",message:e.message},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/api-keys/route",pathname:"/api/admin/api-keys",filename:"route",bundlePath:"app/api/admin/api-keys/route"},resolvedPagePath:"C:\\projects\\survivingvid\\src\\app\\api\\admin\\api-keys\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:y}=g,m="/api/admin/api-keys/route";function d(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},5193:(e,t,s)=>{s.d(t,{h:()=>a});class r{constructor(){this.apiKeys=new Map,this.usageHistory=[],this.currentIndex=new Map,this.rateLimitCache=new Map,this.initializeApiKeys(),this.startCleanupInterval()}initializeApiKeys(){[{key:process.env.GEMINI_API_KEY||process.env.GOOGLE_AI_API_KEY||"",name:"Gemini Primary",provider:"google",priority:1,rateLimitPerMinute:60,quotaPerDay:1e4,enabled:!0,usageCount:0,errorCount:0},{key:process.env.GEMINI_BACKUP_KEY_1||"",name:"Gemini Backup 1",provider:"google",priority:2,rateLimitPerMinute:60,quotaPerDay:5e3,enabled:!!process.env.GEMINI_BACKUP_KEY_1,usageCount:0,errorCount:0},{key:process.env.GEMINI_BACKUP_KEY_2||"",name:"Gemini Backup 2",provider:"google",priority:3,rateLimitPerMinute:60,quotaPerDay:5e3,enabled:!!process.env.GEMINI_BACKUP_KEY_2,usageCount:0,errorCount:0},{key:process.env.HUGGINGFACE_API_KEY||"",name:"HuggingFace Primary",provider:"huggingface",priority:1,rateLimitPerMinute:30,quotaPerDay:1e3,enabled:!!process.env.HUGGINGFACE_API_KEY,usageCount:0,errorCount:0}].forEach(e=>{if(e.key&&e.enabled){let t=this.generateKeyId(e);this.apiKeys.set(t,e),this.currentIndex.set(e.provider,0),this.rateLimitCache.set(t,[]),console.log(`ðŸ”‘ API Key registered: ${e.name} (${e.provider})`)}}),console.log(`ðŸ” API Key Manager initialized: ${this.apiKeys.size} keys loaded`)}getApiKey(e){let t=Array.from(this.apiKeys.entries()).filter(([t,s])=>s.provider===e&&s.enabled&&!this.isKeyBanned(s));if(0===t.length)return console.error(`âŒ No available API keys for provider: ${e}`),null;for(let[e,s]of(t.sort(([e,t],[s,r])=>t.priority!==r.priority?t.priority-r.priority:t.usageCount-r.usageCount),t))if(!this.isRateLimited(e))return this.recordKeyUsage(e),s.key;return console.warn(`âš ï¸ All API keys rate limited for provider: ${e}`),null}recordUsage(e,t,s,r,a,i){let n={keyId:e,timestamp:Date.now(),endpoint:t,success:s,responseTime:r,tokensUsed:a,cost:i};this.usageHistory.push(n),this.updateKeyStats(e,s,r),this.usageHistory.length>1e4&&(this.usageHistory=this.usageHistory.slice(-1e4))}reportError(e,t){let s=this.apiKeys.get(e);if(s){if(s.errorCount++,s.errorCount>=5){let e=Math.min(6e4*Math.pow(2,s.errorCount-5),36e5);s.bannedUntil=Date.now()+e,console.warn(`ðŸš« API Key banned: ${s.name} (${Math.round(e/6e4)} minutes)`)}console.error(`ðŸš¨ API Key Error: ${s.name} - ${t.message}`)}}getStats(e){let t={};for(let[s,r]of this.apiKeys.entries()){if(e&&r.provider!==e)continue;let a=this.usageHistory.filter(e=>e.keyId===s);t[s]={totalRequests:a.length,successfulRequests:a.filter(e=>e.success).length,failedRequests:a.filter(e=>!e.success).length,averageResponseTime:a.length>0?a.reduce((e,t)=>e+t.responseTime,0)/a.length:0,totalCost:a.reduce((e,t)=>e+(t.cost||0),0),quotaUsage:r.usageCount/r.quotaPerDay*100,rateLimitHits:this.getRateLimitHits(s)}}return t}getSecurityReport(){let e=Date.now()-36e5,t=Array.from(this.apiKeys.values()).filter(e=>e.enabled&&!this.isKeyBanned(e)).length,s=Array.from(this.apiKeys.values()).filter(e=>this.isKeyBanned(e)).length,r=Array.from(this.apiKeys.entries()).filter(([e,t])=>t.usageCount/t.quotaPerDay>.8).map(([e,t])=>e),a=this.usageHistory.filter(t=>!t.success&&t.timestamp>e).length,i=Array.from(this.rateLimitCache.values()).reduce((e,t)=>e+t.length,0);return{totalKeys:this.apiKeys.size,activeKeys:t,bannedKeys:s,highUsageKeys:r,errorsInLastHour:a,rateLimitHits:i}}resetDaily(){for(let e of this.apiKeys.values())e.usageCount=0,e.errorCount=0,e.bannedUntil=void 0;this.usageHistory=[],this.rateLimitCache.clear(),console.log("\uD83D\uDD04 API Key Manager: Daily reset completed")}isRateLimited(e){let t=this.apiKeys.get(e);if(!t)return!0;let s=Date.now()-6e4,r=(this.rateLimitCache.get(e)||[]).filter(e=>e>s);return this.rateLimitCache.set(e,r),r.length>=t.rateLimitPerMinute}isKeyBanned(e){return!!e.bannedUntil&&Date.now()<e.bannedUntil}recordKeyUsage(e){let t=this.rateLimitCache.get(e)||[];t.push(Date.now()),this.rateLimitCache.set(e,t)}updateKeyStats(e,t,s){let r=this.apiKeys.get(e);r&&(r.usageCount++,r.lastUsed=Date.now(),!t&&r.errorCount++)}getRateLimitHits(e){return this.rateLimitCache.get(e)?.length||0}generateKeyId(e){return`${e.provider}_${e.name.replace(/\s+/g,"_").toLowerCase()}`}startCleanupInterval(){setInterval(()=>{let e=Date.now()-864e5;for(let[t,s]of(this.usageHistory=this.usageHistory.filter(t=>t.timestamp>e),this.rateLimitCache.entries())){let r=s.filter(t=>t>e);0===r.length?this.rateLimitCache.delete(t):this.rateLimitCache.set(t,r)}},36e5)}}let a=new r}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[9276,5972],()=>s(1215));module.exports=r})();